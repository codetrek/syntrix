# Unified Server Module Requirements

**Date:** January 3, 2026
**Status:** Accepted

## 1. Background & Problem Statement

Currently, Syntrix has multiple server implementations scattered across the codebase:
- **API Gateway**: Created in `internal/services/manager_init.go` using raw `http.Server`.
- **Puller gRPC**: Created in `internal/puller/internal/grpc/server.go` using `grpc.NewServer`.
- **Puller Health**: Created in `internal/puller/internal/health/health.go`.
- **Query Service**: Created in `internal/services/manager_init.go`.

**Issues:**
1.  **Inconsistent Configuration**: Timeouts (Read/Write/Idle) are not consistently applied, posing availability risks (e.g., Slowloris attacks).
2.  **Fragmented Lifecycle**: Graceful shutdown logic is duplicated or missing in some parts.
3.  **Observability Gaps**: Middleware for logging, metrics, and panic recovery is applied ad-hoc.
4.  **Maintenance Overhead**: Changing a global default (e.g., adding a security header) requires editing multiple files.

## 2. Goals

Create a unified `internal/server` package to:
1.  **Standardize Creation**: Provide factory methods for HTTP and gRPC servers.
2.  **Enforce Best Practices**: Mandatory timeouts, secure defaults, and standard middleware.
3.  **Unified Lifecycle**: Expose a common interface (`Start`, `Stop`) for the Service Manager.
4.  **Centralize Observability**: Automatically inject standard logging and metrics interceptors.

## 3. Functional Requirements

### 3.1 HTTP Server
- **Configuration**:
    - Port / Host
    - ReadTimeout, WriteTimeout, IdleTimeout (with safe defaults)
    - MaxHeaderBytes
- **Middleware (Default)**:
    - Panic Recovery
    - Structured Logging (slog)
    - Request ID generation/propagation
    - CORS (Configurable)
- **Features**:
    - Support for Graceful Shutdown with configurable timeout.
    - Health check endpoint support.

### 3.2 gRPC Server
- **Configuration**:
    - Port / Host
    - MaxConcurrentStreams
    - Keepalive parameters
- **Interceptors (Default)**:
    - Panic Recovery
    - Structured Logging
    - Tracing (OpenTelemetry)
- **Features**:
    - Reflection support (configurable for dev/prod).
    - Graceful Shutdown.

### 3.3 Lifecycle Management
- **Graceful Shutdown**: The server must support context-based graceful shutdown to allow active connections to drain.
- **Identification**: Each server instance should be identifiable (e.g., by name) for logging and debugging purposes.

## 4. Non-Functional Requirements

- **Zero-Config Defaults**: Should work out-of-the-box with safe defaults for development.
- **Extensibility**: Allow services to inject custom middleware/interceptors without breaking the abstraction.
- **Dependency Isolation**: The server module should not depend on business logic packages (e.g., `engine`, `puller`).

## 5. Out of Scope (Phase 1)
- Dynamic port reloading.
- Advanced traffic shaping / rate limiting (handled by Gateway logic, not raw server).
