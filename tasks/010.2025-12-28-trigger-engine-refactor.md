# Trigger Engine Refactor & Factory Wiring

Date: 2025-12-28
Status: Planned
Scope: Trigger engine + factory/interfaces, watcher/checkpoint, publisher/consumer hashing & validation, worker/auth/signature, observability, migration/testing
Reference Design: docs/design/server/trigger/000_requirements.md; 001_architecture.md; 002_interfaces.md; docs/design/server/trigger/README.md; docs/design/server/trigger/architecture.md

## Objectives

- Introduce `TriggerFactory` + `TriggerEngine` with error-returning `LoadTriggers`, enforcing tenant/collection/docKey validation and fail-fast startup.
- Encapsulate watch/checkpoint logic in a `DocumentWatcher` adapter with tenant-scoped checkpoints, context-aware cancellation, and explicit start-from-now opt-in + audit signal.
- Enforce subject-safe publishing (base64url docKey, NATS length guard with hash fallback) and consumer partitioning/idempotency keyed by decoded docKey, not hashed segment.
- Strengthen worker HTTP path (configurable timeout/client, tenant-scoped secret/token retrieval, signature header) and retry/backoff parity with design.
- Add observability for publish/consume/worker success, retries, latency, hash-path traffic (`subjectHashed`), collisions, and checkpoint resets.
- Provide migration guidance/tests so callers handle `LoadTriggers` errors and new validation behaviors.

## Known Issues to Address (from Design Review)

The following issues identified in design review must be resolved during this refactor:

- **Replication pull gap**: Current query engine uses `updatedAt > checkpoint`, skipping docs with identical timestamps. Fix: Pull filter must be inclusive (`updatedAt >= checkpoint`) with secondary sort key (e.g., `id`).
- **Push input validation**: Missing validation for empty path when neither `Fullpath` nor `id` is present. Fix: Reject invalid requests before storage call.
- **Watch cancellation/timeout**: `WatchCollection` lacks read timeouts and context awareness in decode loop. Fix: Add client timeouts and context-aware read loops to prevent goroutine leaks.
- **Delete conflict masking**: `ErrNotFound` treated as success in delete flow. Fix: Surface version conflicts when delete preconditions fail.
- **Watch error observability**: JSON decode errors are swallowed. Fix: Propagate errors to callers to distinguish stream corruption from graceful close.
- **Loader error signaling gap**: `LoadTriggers` swallows errors. Fix: Return error on validation failure to prevent partial activation.
- **Hash-guard partitioning ambiguity**: Partitioning on hashed subject segment breaks ordering. Fix: Consumer must partition on decoded docKey from payload.
- **Hash observability gap**: Lack of visibility into hash-path traffic. Fix: Add `subjectHashed=true` metric dimension and collision logging.
- **Checkpoint reset risk**: Silent "start from now" on missing checkpoint. Fix: Require explicit opt-in or emit audit/metric.
- **Hash collision handling**: Define consumer behavior (serialize/fail) and alert thresholds for hash collisions.
- **Hash branch retry/alert tuning**: Consider stricter retry caps/timeouts for hash-path traffic.
- **"Start from now" audit/RBAC**: Define audit sink and authorization for skipping historical events.
- **LoadTriggers error migration**: Document caller migration steps (fail-fast/health check) for new error returns.
- **Secret/token failure observability**: Add labeled metrics for secret/token fetch failures.

## Plan / Milestones

### M1: Interfaces, Factory & Wiring (Migration Steps 1, 4, 6)
- [ ] **Create Package Structure**:
    - Create `internal/trigger/engine`
    - Create `internal/trigger/internal/watcher`
    - Create `internal/trigger/internal/pubsub`
    - Create `internal/trigger/internal/worker`
    - Create `internal/trigger/internal/config`
    - Create `internal/trigger/internal/evaluator`
- [ ] **Define Interfaces (`internal/trigger/engine/interfaces.go`)**:
    - `TriggerEngine`: `LoadTriggers`, `Start`, `Close`.
    - `TriggerFactory`: `Engine`, `Close`.
- [ ] **Define Adapter Interfaces**:
    - `internal/trigger/internal/watcher/interfaces.go`: `DocumentWatcher`.
    - `internal/trigger/internal/pubsub/interfaces.go`: `TaskPublisher`, `TaskConsumer`.
    - `internal/trigger/internal/worker/interfaces.go`: `DeliveryWorker`.
- [ ] **Implement Factory (`internal/trigger/engine/factory.go`)**:
    - `defaultTriggerFactory` (Unexported): Holds dependencies (Storage, NATS, AuthN).
    - `NewFactory(...)`: Exported constructor returning `TriggerFactory` interface.
    - `Engine()`: Initial skeleton. Wires up `Evaluator` (available in M1). *Note: Watcher and PubSub will be wired in M3/M4.*
    - **Refactor**: Move `evaluator.go` to `internal/trigger/internal/evaluator/` for consistency.
- [ ] **Refactor Engine (`internal/trigger/engine/engine.go`)**:
    - `defaultTriggerEngine` (Unexported): Orchestrates the flow.
    - `Start()`: Skeleton flow (Watcher -> Evaluator -> Publisher).
    - `LoadTriggers()`: Updates state, returns error (placeholder for validation).

### M2: Validation & Loader (Migration Step 7)
- [ ] **Implement Validation**:
    - Create `internal/trigger/validation.go`: Add `ValidateTrigger(t *Trigger) error`.
    - Check tenant/collection charset (alphanumeric, dash, underscore).
    - Check docKey safety (no `.` `*` `>`).
- [ ] **Update Loader**:
    - In `internal/trigger/engine/engine.go`: Call validation in `LoadTriggers`.
    - Fail fast if any trigger is invalid.
- [ ] **Fix Push Input Validation**:
    - Ensure `LoadTriggers` or the upstream caller validates empty paths.

### M3: Watcher & Checkpoints (Migration Steps 2, 8)
- [ ] **Extract Watcher**:
    - Move `Watch` logic from `service.go` to `internal/trigger/internal/watcher/watcher.go`.
    - Implement `DocumentWatcher` interface.
    - **Update Factory**: Wire `DocumentWatcher` into `Engine`.
- [ ] **Update Checkpoints**:
    - Change checkpoint key to `sys/checkpoints/trigger_evaluator/<tenant>[/<collection>]`.
    - Implement `SaveCheckpoint`.
- [ ] **Fix Watch Issues**:
    - Add `context` check in read loop.
    - Add timeout to underlying HTTP client (if applicable) or read deadline.
    - Propagate JSON decode errors.
    - Fix "Replication pull gap" (inclusive filter).
    - Fix "Delete conflict masking".
- [ ] **Start-From-Now**:
    - Implement logic to handle missing checkpoint.
    - **Behavior**: If no checkpoint exists and no "start-from-now" flag is provided, return error or wait (do not silently skip history).
    - Add audit log/metric if starting from now.

### M4: Publisher & Consumer (Migration Steps 3, 7)
- [ ] **Move Pub/Sub**:
    - Move `publisher.go` -> `internal/trigger/internal/pubsub/publisher.go`.
    - Move `consumer.go` -> `internal/trigger/internal/pubsub/consumer.go`.
    - **Update Factory**: Wire `TaskPublisher` and `TaskConsumer` into `Engine`.
- [ ] **Enhance Publisher**:
    - Implement `EncodeDocKey` (base64url).
    - Implement `HashSubject` (SHA-256 trunc 32) if length > 1024.
    - Set `subjectHashed` flag in `DeliveryTask`.
- [ ] **Enhance Consumer**:
    - Update `dispatch` to use `task.DocKey` (decoded) for partitioning.
    - Log collision if `subjectHashed` is true and hash matches but docKey differs (if possible to detect).

### M5: Worker & Auth/Signature (Migration Step 5)
- [ ] **Move Worker**:
    - Move `worker.go` -> `internal/trigger/internal/worker/worker.go`.
- [ ] **Enhance Worker**:
    - Update `NewDeliveryWorker` to accept `HTTPClientOptions` (timeout).
    - Inject `SecretProvider` (interface) for `SecretsRef` resolution.
    - Implement `GenerateSystemToken` using `identity.AuthN` (already there, verify tenant scope).
    - Ensure 4xx returns fatal error (wrapped), 5xx returns retryable error.

### M6: Observability & Telemetry
- [ ] **Add Metrics**:
    - Define metrics in `internal/trigger/metrics.go`.
    - Instrument `Publish`, `Consume`, `ProcessTask`.
    - Add `subjectHashed` label.
- [ ] **Add Audit**:
    - Log audit event in `watcher.go` when starting from now.

### M7: Migration & Tests (Migration Step 9)
- [ ] **Update Callers**:
    - Update `cmd/syntrix/main.go` (or wherever trigger service is started) to use `TriggerFactory`.
    - Handle `LoadTriggers` error.
- [ ] **Unit Tests**:
    - Add tests for `validation.go`.
    - Add tests for `watcher.go` (checkpointing).
    - Add tests for `publisher.go` (encoding/hashing).
    - Add tests for `consumer.go` (partitioning).

## Deliverables

- New engine/factory implementation with adapters.
- Validation utilities.
- Config structs.
- Telemetry hooks.
- Comprehensive test suite.

## Risks & Mitigations

- Risk: Caller ignores new LoadTriggers errors → Mitigation: migration guide + startup fail-fast pattern.
- Risk: Hash fallback collision handling unclear → Mitigation: explicit strategy + metrics/alerts.
- Risk: Start-from-now used without audit → Mitigation: require explicit flag and emit audit/metric.
